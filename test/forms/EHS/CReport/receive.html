<script>
    function HSE_receiveController(
        $scope, EngineApi, $http, Notifications, $compile, $filter, Auth, $resource,
        Auth, GateGuest, $translate, CReportService, $filter, $q, $timeout) {
        var lang = window.localStorage.lang;
        const con_flowkey = 'Receive_HSE_Users';
        $translate.refresh();
        $scope.passOrNot = [{
            "name": $translate.instant('agree'),
            "value": "YES"
        },
        {
            "name": $translate.instant('notAgree'),
            "value": "NO"
        }
            // { "name": 'DeleteVoucher', "value": "Cancel" } //maybe for later function
        ];
        $scope.disableSubmit = Auth.username.indexOf('FEPVNN') > -1 ? false : false;
        $scope.loading = false;

        $scope.$watch('checkList', function (val) {
            if (val !== undefined && val !== null) {
                if (val.length == 3)
                    $timeout(function () {
                        if ($scope.ReportDetail.Rp_SubmitTypeCode == 'EVR') { //user 'EVR', see line 36 in CreportDirective for more inforation
                            $scope.checkList.splice(0, 1, 'FEPV000096');
                            $scope.leaderlist.splice(0, 1, {
                                $$hashKey: "",
                                LevelNameVN: "Kiểm tra 審核人員",
                                Person: "FEPV000096" // Thi Sinh
                            });
                        }
                        if ($scope.ReportDetail.Rp_SubmitTypeCode == 'SF') { //same as above, had to change this (by mistake =.=!)
                            $scope.checkList.splice(0, 1, 'FEPV000559');
                            $scope.leaderlist.splice(0, 1, {
                                $$hashKey: "",
                                LevelNameVN: "Kiểm tra 審核人員",
                                Person: "FEPV000559" // Xi long
                            });
                        }
                        if ($scope.ReportDetail.Rp_SubmitTypeCode == 'FP') { //same as above, had to change this (by mistake =.=!)
                            $scope.checkList.splice(0, 1, 'FEPV000944');
                            $scope.leaderlist.splice(0, 1, {
                                $$hashKey: "",
                                LevelNameVN: "Kiểm tra 審核人員",
                                Person: "FEPV000944" //other
                            });
                        }
                    }, 500)

            }
        })


        $scope.Save = function (isSubmit) {
            debugger;
            $scope.loading = true;
            if ($scope.ISReceive == 'NO') {
                CReportService.SubmitStatus({
                    Rp_ID: $scope.variable.Rp_ID,
                    Rp_Status: 'PW' // processing wait status, Initiator must update this report later
                }, function (res) {
                    if (res.Success) {
                        SaveBpmn();
                    }
                },
                    function (err) {
                        Notifications.addError({
                            'status': 'error',
                            'message': 'UPdate status Error' + err
                        });
                    }
                ); //end changestatusservice
            } //end if
            else SaveBpmn();

        } //save



        function SaveBpmn() {
            // if ($scope.checkList && checkList.length >= 0) {
            $scope.formVariables.push({
                name: 'Receive_HSE_Users',
                value: $scope.checkList
            });
            $scope.formVariables.push({
                name: 'Rp_ID',
                value: $scope.variable.Rp_ID //chosen
            });

            $q.all([$scope.submit()]).then(function () {
                // var reminder_parrams = {
                //     voucherID: $scope.VoucherID,
                //     userid: Auth.username,
                //     formkey: 'leadercheck'
                // }
                // LIMSService.SendReminder(reminder_parrams, function (res) {
                //     if (res.Success) return;
                // }, function (error) {
                //     Notifications.addError({
                //         'status': 'error',
                //         'message': $translate.instant('saveError') + error
                //     });
                // })
            });
            // }

            // else {
            //     Notifications.addError({
            //         'status': 'error',
            //         'message': 'Don\'t get leader'
            //     });
            //     return;
            // }

        }


    }
</script>
<div ng-controller="HSE_receiveController">
    <!-- REPORT DIRECTIVE -->
    <!-- <approval-master vid='{{variable.OverID}}' style="width: 85%"></approval-master> -->
    <receive-report Rp_ID='{{variable.Rp_ID}}' style="width: 85%"></receive-report>

    <!-- CHOOSE FORM -->
    <form class="form-horizontal" role="form" novalidate name="form">
        <!-- RECEVEIVE AND PROCESS FORM -->
        <div class="form-group">
            <label class="col-sm-2 control-label">{{'IsPass'|translate}}:</label>
            <div class="col-sm-4">
                <select class="form-control" history-field="ISReceive" form-field name="ISReceive" ng-model="ISReceive"
                    ng-options="c.value as c.name for c in passOrNot" required> </select>
            </div>
        </div>
        <!-- DENY TEXTAREA -->
        <div class="form-group" ng-if="ISReceive=='NO'">
            <label class="col-sm-2  control-label">*{{'DenyReason'|translate}}:</label>
            <div class="col-sm-6">
                <textarea class="form-control" name="leadercheck_remark" type="text" form-field
                    history-field="DenyReason" ng-model="leadercheck_remark" rows="3" required />
                </div>
        </div>

        <!-- leader remark show if returned -->
        <!-- <div>
            <h3 style="color:red;">
                {{variable.leadername}} Remark: {{variable.leadercheck_remark}}
            </h3>
        </div> -->
        <!-- NEXT CANDIDATE -->
        <div class="form-group" style="padding-left: 3%">
            <div>
                <h4>{{'NextStep'|translate}}</h4>
            </div>
            <div  ehs-leader-check 
                submitdepartid=""
                flow-key="CReportHSE" 
                kinds="receive"></div>
        </div>

        <!-- BUTTON OF SUBMITTING -->
        <div class="form-group" ng-hide="recod.Status=='K'">
            <div class="col-sm-offset-6 col-sm-2">
                <button class="btn btn-primary" ng-click="Save(true)"
                    ng-disabled="form.$invalid||disableSubmit||loading">
                    {{'Save Submit'|translate}}
                </button>
            </div>
        </div>

    </form>
</div>