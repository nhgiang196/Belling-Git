<script>
    function RYVoucherCheck(
        $scope, EngineApi, $http, Notifications, $compile, $filter, Auth, $resource,
        Auth, GateGuest, $translate, CReportService, InfolistService, $filter, $q, $timeout, $upload) {

        /***************************************** INIT **************************************************/
        $scope.recordIC = {}; //for IC directive enity
        $scope.recordAC = {}; //for AC Directive enity
        $scope.listfile = []; // list of general files
        $scope.listfileAC = []; // list of injury files
        $scope.status = 'M'; //this form only for Modified
        $scope.mySwitch = true; //Enable File UPload at Rp_Location
        $scope.ISReceive = 'Yes'; //default submit choose
        var lang = window.localStorage.lang || 'EN';
        var lang = window.localStorage.lang;
        $scope.username = Auth.username;
        $scope.recod = {};
        $translate.refresh();


        // report type combobox
        $scope.typelist = [{
                id: 'all',
                name: $translate.instant('All')
            },
            {
                id: '0',
                name: $translate.instant('Incident')
            },
            {
                id: '1',
                name: $translate.instant('Accident')
            }
        ];
        //status combobox
        $scope.statuslist = InfolistService.Infolist('status');
        //evaluate combobox
        $scope.evaluatelist = InfolistService.Infolist('evaluate');
        // location combobox
        $scope.locationlist = InfolistService.Infolist('location');
        // AC type combobox
        $scope.ACTypelist = InfolistService.Infolist('ACType');
        // Submit type combobox
        $scope.SubmitTypelist = InfolistService.Infolist('SubmitType');
        $scope.rp_Submittype = $scope.SubmitTypelist[0];


        //------------------------NOTIFICATION GROUP----------------------------------
        $scope.save_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'information',
                    'message': $translate.instant('Save_Success_MSG')
                });
            }, 200);
        }

        $scope.nofileLoc = function () {
            $timeout(function () {
                Notifications.addError({
                    'status': 'error',
                    'message': $translate.instant('File_Location')
                });
            }, 200);
        }

        $scope.update_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'information',
                    'message': $translate.instant('Update_Success_MSG')
                });
            }, 300);
        }

        $scope.ac_details_msg = function () {
            Notifications.addMessage({
                'status': 'information',
                'message': $translate.instant('ACDetails_Msg')
            });
        }

        $scope.submit_success_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'info',
                    'message': $translate.instant('Submit_Success_MSG')
                });
            }, 300);
        }

        $scope.save_error_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'error',
                    'message': $translate.instant('Msg_Save')
                });
            }, 300);
        }

        $scope.update_error_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'error',
                    'message': $translate.instant('UpdateError')
                });
            }, 300);
        }

        $scope.same_employee_msg = function () {
            $timeout(function () {
                Notifications.addMessage({
                    'status': 'error',
                    'message': $translate.instant('SameEmployee')
                });
            }, 300);
        }

        /***************************************** FUNCTIONS **************************************************/
        /* Upload file functions*/
        $scope.btnfile = function (id, filename) {
            var filein = document.querySelector("#" + id);
            var filename = document.querySelector("#" + filename);
            filein.click();
        }
        $scope.UploadFileHSE = function ($files, _colName) {

            $upload.upload({
                url: '/Waste/files/Upload',
                method: "POST",
                file: $files
            }).progress(function (evt) {

            }).then(function (res) {

                res.data.forEach(x => {
                    var chuthuong = x.toLowerCase();
                    var dt = {
                        name: x,
                        col: _colName
                    };
                    if (_colName == 'Injury_Description')
                        if (chuthuong.includes(".doc") || chuthuong.includes(".docx") || chuthuong
                            .includes(".pdf") || chuthuong.includes(".jpg") || chuthuong.includes(
                                ".jpeg") || chuthuong.includes(".png"))
                            $scope.listfileAC.push(dt);
                        else {
                            $timeout(function () {
                                Notifications.addMessage({
                                    'status': 'info',
                                    'message': $translate.instant(
                                        'FileValidation_MSG')
                                });
                            }, 300);

                            var namefile = {
                                fname: x
                            };

                            CReportService.DeleteFile(namefile, res);
                        }
                    else if (_colName == 'Rp_Description')
                        if (chuthuong.includes(".doc") || chuthuong.includes(".docx") || chuthuong
                            .includes(".pdf") || chuthuong.includes(".jpg") || chuthuong.includes(
                                ".jpeg") || chuthuong.includes(".png"))
                            $scope.listfile.push($scope.dt);
                        else {
                            $timeout(function () {
                                Notifications.addMessage({
                                    'status': 'info',
                                    'message': $translate.instant(
                                        'FileValidation_MSG')
                                });
                            }, 300);

                            var namefile = {
                                fname: x
                            };
                            CReportService.DeleteFile(namefile, res);
                        }
                    else
                    if (chuthuong.includes(".jpg") || chuthuong.includes(".jpeg") || chuthuong
                        .includes(".png") || chuthuong.includes(".pdf"))
                        $scope.listfile.push(dt);
                    else {

                        $timeout(function () {
                            Notifications.addMessage({
                                'status': 'info',
                                'message': $translate.instant(
                                    'FileValidation_IMG_MSG')
                            });
                        }, 300);

                        var namefile = {
                            fname: x
                        };
                        CReportService.DeleteFile(namefile, res);
                    }
                })

            })
        }

        $scope.passOrNot = [{
                "name": $translate.instant('Update'),
                "value": "UPDATE"
            },
            {
                "name": $translate.instant('Delete'),
                "value": "DELETE"
            }
            // { "name": 'DeleteVoucher', "value": "Cancel" }
        ];

        $scope.disableSubmit = Auth.username.indexOf('FEPVNN') > -1 ? false : false;
        $scope.loading = false;
        /*Submit button*/


        function saveInitData() {
            var note = {};
            note.userID = Auth.username;
            note.voucherID = $scope.VoucherID || '';
            note.reason = $scope.recod.Reason || '';
            note.solution = $scope.recod.Solution || '';
            note.prevention = $scope.recod.Prevention || '';
            note.remark = $scope.leadercheck_remark || '';
            note.status = $scope.recod.Status || '';
            note.state = $scope.recod.State || '';
            return note;
        }
        /**
         * Update status by updateByID
         */
        $scope.Submit = function (isSubmit) {
            if (!confirm("Submit this Report?")) return;
            if ($scope.checkList.length <= 0) {
                Notifications.addError({
                    'status': 'error',
                    'message': 'Don\'t get leader'
                });
                return;
            }
            // $scope.formVariables.push({
            //     name: 'Rp_ID',
            //     value: $scope.variable.Rp_ID //chosen
            // });
            $scope.submit();
            // var data = saveInitData();
        }
        $scope.recordIC = {};
        $scope.recordAC = {};


        LoadDetail();

        function LoadDetail() {
            CReportService.FindByID({
                Rp_ID: $scope.variable.Rp_ID
            }, function (data) {

                if (data.Rp_Type == "IC")
                    $scope.IsIC = true;
                else $scope.IsIC = false;

                $scope.recordIC.rp_id = data.Rp_ID;
                $scope.recordIC.icGroup = data.RpIC_Group;
                $scope.recordIC.ic_departmentid = data.Rp_DepartmentID;
                $scope.recordIC.ic_SubDeparmentid = data.Rp_SubDepartmentID;
                $scope.recordIC.ic_deparid = data.Rp_DepartmentID;
                $scope.recordIC.icDatetime = data.Rp_DateTime;
                $scope.recordIC.icLocation = data.Rp_Location;
                $scope.recordIC.icPrevent = data.Rp_PreventMeasure;
                $scope.recordIC.icProcess = data.RpIC_Description;
                $scope.recordIC.icDr_reason = data.RpIC_DirectReason;
                $scope.recordIC.icIdr_reason = data.RpIC_IndirectReason;
                $scope.recordIC.icBasic = data.RpIC_BasicReason;
                $scope.recordIC.icResult = data.RpIC_Damage;
                $scope.recordIC.icImprove = data.RpIC_Process;
                $scope.recordIC.icEvaluate = data.RpIC_Evaluate;
                $scope.recordIC.icType = data.RpIC_IncidentType;

                $scope.listfile = [];

                $scope.recordAC.rp_id = data.Rp_ID;
                $scope.recordAC.ac_subdepartment = data.Rp_SubDepartmentID;
                $scope.recordAC.ac_type = data.Rp_Type;
                $scope.recordAC.ac_datetime = data.Rp_DateTime;
                $scope.recordAC.ac_location = data.Rp_Location;
                $scope.recordAC.ac_prevent = data.Rp_PreventMeasure;
                $scope.recordAC.ac_improvesoft = data.RpAC_ImproveSoftware;
                $scope.recordAC.ac_improvehard = data.RpAC_ImproveHardware;
                $scope.recordAC.ac_datecomp = data.RpAC_DateComplete;
                $scope.recordAC.ac_resultsoft = data.RpAC_ResultSoftware;
                $scope.recordAC.ac_resulthard = data.RpAC_ResultHardware;
                $scope.recordAC.submittype = data.Rp_SubmitType;

                $scope.employees = [];
                $scope.gd = {};
                $scope.showEmployeeList(data.Rp_SubDepartmentID);
                data.AccidentDetail.forEach(element => {
                    var x = {};
                    x.Injury_Description = element.Injury_Description;
                    x.Rp_ID = element.Rp_ID;
                    x.Treatment_Result = element.Treatment_Result;
                    x.Witness_info = element.Witness_info;
                    x.EmployeeID = element.EmployeeID;
                    x.Contractor_Victim_Name = element.Contractor_Victim_Name;
                    x.Contractor_Victim_Sex = element.Contractor_Victim_Sex;
                    x.Contractor_Victim_Age = element.Contractor_Victim_Age;
                    x.Contractor_Name = element.Contractor_Name;
                    x.Contractor_Victim_DateWork = element.Contractor_Victim_DateWork;
                    x.Contractor_Victim_Work = element.Contractor_Victim_Work;
                    $scope.employees.push(x);
                })
                $scope.injury = [];
                data.FileAttached.forEach(element => {
                    if (element.Profile_ID == null) {
                        var x = {};
                        x.Rp_ID = element.Rp_ID;
                        x.name = element.File_ID;
                        x.col = element.ColumnName;
                        $scope.listfile.push(x);
                    } else {
                        var x = {};
                        x.Rp_ID = element.Rp_ID;
                        x.name = element.File_ID;
                        x.empID = element.Profile_ID;
                        x.col = element.ColumnName;
                        $scope.injury.push(x);
                    }
                });

                $scope.showBtnFile();


            }, function (error) {
                Notifications.addError({
                    'status': 'error',
                    'message': res.Message
                });
            })
        }

        //Choose SubDepartment to show Employees 
        $scope.showEmployeeList = function (dept_id) {
            if (dept_id == null || dept_id == '') return;
            CReportService.GetEmployee({
                DepartmentID: dept_id
            }, function (res) {
                if (res.length > 0) {
                    $scope.listEmployee = res;
                } else $scope.listEmployee = [];
            })
        };


    }
</script>
<div ng-controller="RYVoucherCheck">
    <!-- REPORT DIRECTIVE -->
    <!-- <approval-master vid='{{variable.OverID}}' style="width: 85%"></approval-master> -->
    <!-- <receive-report Rp_ID='{{variable.Rp_ID}}' style="width: 85%"></receive-report> -->
    <div ng-show="IsIC">
        <create_ic_report></create_ic_report>
    </div>
    <div ng-if="!IsIC">
        <create_ac_report></create_ac_report>
    </div>

    <!-- CHOOSE FORM -->
    <form class="form-horizontal" role="form" novalidate name="form">
        <!-- RECEVEIVE AND PROCESS FORM -->


        <div class="form-group">
            <label class="col-sm-2 control-label">{{'IsPass'|translate}}:</label>
            <div class="col-sm-3">
                <select class="form-control" history-field="UpdateCommand" form-field name="UpdateCommand"
                    ng-model="UpdateCommand" ng-options="c.value as c.name for c in passOrNot" required> </select>
            </div>
        </div>

        <!-- leader remark show if returned -->
        <!-- <div>
            <h3 style="color:red;">
                {{variable.leadername}} Remark: {{variable.leadercheck_remark}}
            </h3>
        </div> -->
        <!-- NEXT CANDIDATE -->
        <div class="row">
            <div>
                <h4>{{'NextStep'|translate}}</h4>
            </div>
            <div leader-check flow-key="CReportHSE" user-name="{{username}}"></div>
        </div>

        <!-- BUTTON OF SUBMITTING -->
        <div class="form-group" ng-hide="recod.Status=='K'">
            <div class="col-sm-offset-2 col-sm-10">
                <button class="btn btn-primary" ng-click="Submit(true)"
                    ng-disabled="form.$invalid||disableSubmit||loading">
                    {{'Submit'|translate}}
                </button>
            </div>
        </div>
    </form>
</div>