<style>
    .modal-lg {
        width: 900px;
    }

    .form-table {
        width: 100%;
        display: inline-block;
        padding: 15px 0px;
        margin-bottom: 15px;
    }

    .form-group {
        margin-bottom: 5px
    }

    li {
        list-style-type: none;
    }

    li ul {
        display: none;
        border: 1px solid #000000;
        margin-left: -3px;
    }

</style>
<script type="text/javascript">
    function GateGuest_start($scope, EngineApi, $http, $timeout, Notifications, $compile,$routeParams, $upload, $filter, Auth, $resource, $translatePartialLoader, $translate, uiGridConstants, GateGuest) {
        $translatePartialLoader.addPart('GateGuest');
        $translate.refresh();
        var lang = window.localStorage.lang;
        $scope.recod = {};
        $scope.recod.start_name = "";
        $scope.guestItems = [];
        $scope.note = {};

        $scope.details = {};
        $scope.detailsGuestItems = [];
        var historyurl = "";
        $scope.onlyOwner = true;
        $scope.dateFrom = $filter('date')(new Date(), "yyyy-MM-dd");
        $scope.dateTo = $filter('date')(new Date(), "yyyy-MM-dd");
        $scope.bloodTypes = [
            {'id' : 1, 'description' : 'O+'},
            {'id' : 2, 'description' : 'A'},
            {'id' : 3, 'description' : 'B'},
        ];

        // set initial selected option to blood type B
        $scope.selectedOption =  { 'description' : 'B'};
        var paginationOptions = {
            pageNumber: 1,
            pageSize: 50,
            sort: null
        };
        $scope.getVoucherStatus = function (Status) {
            var statLen = $filter('filter')($scope.StatusList, {"Status": Status});
            if (statLen.length > 0) {
                return statLen[0].Remark;
            } else {
                return Status;
            }
        };

        $scope.getVoucherGuestType = function (GuestType) {
            var statLen = $filter('filter')($scope.kind, GuestType);
            if (statLen.length > 0) {
                return statLen[0].GuestType;
            } else {
                return GuestType;
            }
        };
        $scope.getVoucherRegion = function (Region) {
            var statLen = $filter('filter')($scope.regions, Region);
            if (statLen.length > 0) {
                return statLen[0].Region;
            } else {
                return Region;
            }
        };
        var col = [{
            field: 'VoucherID',
            displayName: $translate.instant('VoucherID'),
            minWidth: 130,
            cellTooltip: true,
            cellTemplate: '<a ng-click="grid.appScope.getVoucher(row)"  style="padding:5px;display:block; cursor:pointer">{{COL_FIELD}}</a>'
        },
            {
                field: 'Status',
                minWidth: 100,
                displayName: $translate.instant('Status'),
                cellTooltip: true,
                cellTemplate: '<span  >{{grid.appScope.getVoucherStatus(row.entity.Status)}}</span>'
            },
            {field: 'Content', minWidth: 150, displayName: $translate.instant('Content'), cellTooltip: true},
            {
                field: 'GuestType',
                minWidth: 80,
                displayName: $translate.instant('GuestType'),
                cellTooltip: true,
                cellTemplate: '<span  >{{grid.appScope.getVoucherGuestType(row.entity.GuestType)}}</span>'
            },
            {
                field: 'Region',
                minWidth: 80,
                displayName: $translate.instant('Region'),
                cellTooltip: true,
                cellTemplate: '<span  >{{grid.appScope.getVoucherRegion(row.entity.Region)}}</span>'
            },
            {field: 'Respondent', minWidth: 120, displayName: $translate.instant('Respondent'), cellTooltip: true},
            {field: 'ExtNO', minWidth: 80, displayName: $translate.instant('ExtNO'), cellTooltip: true},
            {field: 'Enterprise', displayName: $translate.instant('Enterprise'), minWidth: 80, cellTooltip: true},
            {field: 'ExpectIn', displayName: $translate.instant('ExpectIn'), minWidth: 150, cellTooltip: true},
            {field: 'InTime', displayName: $translate.instant('InTime'), minWidth: 150, cellTooltip: true},
            {field: 'Complete', displayName: $translate.instant('Complete'), minWidth: 150, cellTooltip: true},
            {field: 'OutTime', displayName: $translate.instant('OutTime'), minWidth: 150, cellTooltip: true},
            {field: 'ExpectOutTime', displayName: $translate.instant('GoodsExpectOut'), minWidth: 80, cellTooltip: true},
            {field: 'VehicleNo', displayName: $translate.instant('VehicleNO'), minWidth: 80, cellTooltip: true},
            {field: 'Stamp', displayName: $translate.instant('Stamp'), minWidth: 150, cellTooltip: true},
            {field: 'UserID', displayName: $translate.instant('UserID'), minWidth: 80, cellTooltip: true}];


        GateGuest.GuestBasic().getGuestType({language: lang}).$promise.then(function (res) {
            $scope.kind = res;
        }, function (errResponse) {
            Notifications.addError({'status': 'error', 'message': errResponse});
        });
        GateGuest.GuestBasic().getGuestRegions({language: lang}).$promise.then(function (res) {
            $scope.regions = res;
        }, function (errResponse) {
            Notifications.addError({'status': 'error', 'message': errResponse});
        });
        GateGuest.GetQueryStatus().get({ctype: 'Guest', language: lang, flag: '1'}).$promise.then(function (res) {
            $scope.StatusList = res;

        }, function (errResponse) {
            Notifications.addError({'status': 'error', 'message': errResponse});
        });


        $scope.gridOptions = {
            columnDefs: col,
            data: [],
            enableColumnResizing: true,
            enableSorting: true,
            showGridFooter: false,
            enableGridMenu: true,
            exporterMenuPdf: false,
            enableSelectAll: false,
            enableRowHeaderSelection: true,
            enableRowSelection: true,
            multiSelect: false,
            paginationPageSizes: [50, 100, 200, 500],
            paginationPageSize: 50,
            enableFiltering: false,
            exporterOlderExcelCompatibility: true,
            useExternalPagination: true,
            enablePagination: true,
            enablePaginationControls: true,
            onRegisterApi: function (gridApi) {
                $scope.gridApi = gridApi;
                EngineApi.getTcodeLink().get({"userid": Auth.username, "tcode": "FEPVGateGuestCreate"}, function (linkres) {
                    if (linkres.IsSuccess) {
                        gridApi.core.addToGridMenu(gridApi.grid, gridMenu);

                    }
                })
                gridApi.selection.on.rowSelectionChanged($scope, function (row) {
                    $scope.selectedVoucherid = row.entity.VoucherID;
                });
                gridApi.pagination.on.paginationChanged($scope, function (newPage, pageSize) {
                    paginationOptions.pageNumber = newPage;
                    paginationOptions.pageSize = pageSize;
                    SearchList(newPage, pageSize);
                });
            }
        };
var gridMenu= [{

    title: $translate.instant("Create"),
    action: function ($event) {
        $('#myModal').modal('show');
        $scope.recod = {};
        $scope.recod.start_name = "";
        $scope.recod.start_date = $filter('date')(new Date(), "yyyy-MM-dd HH:mm");
        $scope.recod.ExpectOutTime = $filter('date')(new Date($scope.recod.start_date),'yyyy-MM-dd 17:00');
        $scope.guestItems = [];
    },
    order: 1
}, {
    title: $translate.instant("Update"),
    action: function ($event) {
        $('#myModal').modal('show');
        var resultRows = $scope.gridApi.selection.getSelectedRows();
        if (resultRows.length == 1) {
            if (resultRows[0].Status == "N" && resultRows[0].UserID == Auth.username) {
                GateGuest.GuestBasic().getGuest({
                    VoucherID: resultRows[0].VoucherID,
                    Language: lang
                }).$promise.then(function (res) {
                            console.log(res);
                            if (res[0].Status == "N" || !res[0].Status) {
                                if (res[0].UserID == Auth.username) {
                                    $scope.recod.start_kind = res[0].GuestType;
                                    $scope.recod.start_code = res[0].Respondent;
                                    $scope.recod.start_area = res[0].Region;
                                    $scope.recod.start_phone = res[0].ExtNO;
                                    $scope.recod.start_company = res[0].Enterprise;
                                    $scope.recod.start_date = res[0].ExpectIn;
                                    $scope.guestItems = res[0].GuestItems;
                                    $scope.recod.start_reason = res[0].Content;
                                    $scope.recod.start_voucherid = res[0].VoucherID;

                                    $('#myModal').modal('show');
                                } else {
                                    Notifications.addError({
                                        'status': 'error',
                                        'message': $translate.instant('creatorError')
                                    });
                                }
                            } else {
                                $scope.details = res[0];
                                //  $scope.details
                                $scope.details.Status = $scope.getVoucherStatus($scope.details.Status);
                                $scope.details.GuestType = $scope.getVoucherGuestType($scope.details.GuestType);
                                $scope.details.Region = $scope.getVoucherRegion($scope.details.Region);

                                $scope.detailsGuestItems = res[0].GuestItems;
                                Notifications.addError({
                                    'status': 'error',
                                    'message': $translate.instant('draftError')
                                });
                                document.getElementById("detailView").style.display = "";
                                document.getElementById("Search").style.display = "none";
                                GateGuest.GetGateGuestPID().get({
                                    VoucherID: obj.entity.VoucherID,
                                    activityName: "StartEvent_Create"
                                }).$promise.then(function (res) {
                                            historyurl = "#/processlog/" + res.ProcessInstanceId;
                                            $scope.$emit('historyurl', historyurl);
                                        }, function (errormessage) {
                                            console.log(errormessage);
                                            //  Notifications.addError({'status': 'error', 'message': errormessage});
                                        });
                            }

                        }, function (errormessage) {
                            Notifications.addError({'status': 'error', 'message': errormessage});
                        });
            }
            else {
                Notifications.addError({'status': 'error', 'message': $translate.instant('Edit_Draf_MSG')})
            }

        } else {
            Notifications.addError({
                'status': 'error',
                'message': $translate.instant('Select_ONE_MSG')
            });
        }
    },
    order: 2
},
    {
        title: $translate.instant('Delete'),
        action: function ($event) {
            var resultRows = $scope.gridApi.selection.getSelectedRows();
            if (resultRows.length == 1) {
                if (resultRows[0].Status == "N" && resultRows[0].UserID == Auth.username) {
                    if (confirm($translate.instant('Delete_IS_MSG') + ":" + resultRows[0].VoucherID)) {
                        GateGuest.GuestBasic().saveGuestStatus({
                            voucherID: resultRows[0].VoucherID,
                            status: "X"
                        }).$promise.then(function (res) {
                                    Notifications.addError({'status': 'info', 'message': "OK"});
                                    SearchList(1, 50);
                                }, function (errormessage) {
                                    Notifications.addError({'status': 'error', 'message': errormessage});
                                });
                    }
                }
                else {
                    Notifications.addError({
                        'status': 'error',
                        'message': $translate.instant('Edit_Draf_MSG')
                    })
                }

            } else {
                Notifications.addError({
                    'status': 'error',
                    'message': $translate.instant('Select_ONE_MSG')
                });
            }
        },
        order: 3

    },{
        title: $translate.instant('PrintReport'),
        action: function ($event) {
            var resultRows = $scope.gridApi.selection.getSelectedRows();
            $scope.voucherID ="";
            if(resultRows.length == 1){
                $scope.voucherID = resultRows[0].VoucherID;
                var href = '#/gate/Guest/print/'+  $scope.voucherID;
                window.open(href);
            }
            else {
                    Notifications.addError({'status': 'error', 'message': 'Please select one application on grid !'});
            }

        },
        order: 4
    }];
        $scope.reset = function () {
            SearchList(1, 50);
            document.getElementById("EmployeeName").readOnly = true;
            document.getElementById("EmployeeID").readOnly = false;
            $('#myModal').modal('hide');
            $('#nextModalGateGuest').modal('hide');
            $('#nextModal').modal('hide');
        };

        function SearchList(pageIndex, pageSize) {
            if ($scope.dateFrom == null && $scope.dateTo == null) {
                Notifications.addError({'status': 'error', 'message': $translate.instant('dataError')});
                return;
            }
            var query = {userID: "", des: ""};
            if ($scope.onlyOwner == true) {
                query.userID = Auth.username;
            }
            else {
                query.userID = "";
            }
            query.PageIndex = pageIndex;
            query.PageSize = pageSize;
            query.voucherID = $scope.VoucherID || "";
            query.status = $scope.status || "";
            query.enterprise = $scope.enterprise || "";
            query.dateFrom = $scope.dateFrom;
            query.dateTo = $scope.dateTo;
            query.region = $scope.region || "";
            query.guestType = $scope.guestType || "";
            GateGuest.GuestBasic().getGuestsList(query).$promise.then(function (res) {
                $scope.gridOptions.data = res.TableData;
                $scope.gridOptions.totalItems = res.TableCount[0];
            }, function (errormessage) {
                Notifications.addError({'status': 'error', 'message': errormessage});
            });
        }

        $scope.Search = function () {
            SearchList(1, 50);
        };
        //获得姓名
        $scope.$watch("recod.start_code", function (n) {
            if (n !== undefined && document.getElementById("EmployeeID").readOnly == false) {
                if (n.length == 10) {
                    var query = {};
                    query.UserID = Auth.username;
                    query.EmployeeID = n;
                    GateGuest.GuestBasic().getNameByEmployeeID(query).$promise.then(function (res) {
                        $scope.recod.start_name = res[0].Name;
                        $scope.recod.DepartmentSpc = res[0].Specification;
                    }, function (errResponse) {
                        Notifications.addError({'status': 'error', 'message': errResponse});
                    });
                } else {
                    $scope.recod.start_name = "";
                }
            }
        });
        $scope.addGuestItem = function () {
           console.log('OKKKKKKKK: '+$scope.note.IdCard);
            if ($scope.note != null || $scope.note != {}) {
                $scope.guestItems.push($scope.note);
                $scope.note = {};
            }
        };

        $scope.deleteGuestItem = function (index) {
            $scope.guestItems.splice(index, 1);

        };
        var saveInit = function (type) {
            var dateObj = {};
            var objemail=[];
            var note = {};
            note.VoucherID = $scope.recod.start_voucherid || "";
            note.Content = $scope.recod.start_reason;
            if ($scope.recod.start_kind == "2") {//SaveGuest
                note.IsNeedConfirm = false;
                dateObj.confirm = "NO"
            }
            else {
                note.IsNeedConfirm = true;
                dateObj.confirm = "YES"
            }
            note.GuestType = $scope.recod.start_kind;
            note.Region = $scope.recod.start_area;
            var employeeID = $scope.recod.start_code;

            note.Respondent = employeeID.toUpperCase();
            note.DepartmentSpc = $scope.recod.DepartmentSpc;
            note.ExtNO = $scope.recod.start_phone;
            note.Enterprise = $scope.recod.start_company;
            note.ExpectIn = $scope.recod.start_date;
            note.UserID = Auth.username;
            note.Status = "N";
            for(var i = 0;i<$scope.guestItems.length;i++){
                if($scope.guestItems[i].IdCard == "" || !$scope.guestItems[i].IdCard){
                    $scope.guestItems[i].IdCard = i;
                }
            }
            note.GuestItems = $scope.guestItems;
            note.ExpectOutTime = $scope.recod.ExpectOutTime;
            note.VehicleNo = $scope.recod.VehicleNo;


            dateObj.note = note;

            return dateObj;
        };

        $scope.modalCancel =function () {
            var dateObj = saveInit();
            var note = dateObj.note;
            SaveGuest(note, function (voucherid, message) {
                if (voucherid) {
                    $scope.recod.start_voucherid = voucherid;
                    Notifications.addMessage({'status': 'information', 'message': $translate.instant('saveSuccess')});
                    SearchList(1, 50);
                    document.getElementById("EmployeeName").readOnly = true;
                    document.getElementById("EmployeeID").readOnly = false;
                    $('#messageModal').modal('hide');
                    $('#nextModalGateGuest').modal('hide');
                    $('#myModal').modal('hide');
                    $('#nextModal').modal('hide');
                } else {
                    Notifications.addError({'status': 'error', 'message': $translate.instant('saveError') + message});
                }
            })

        }
        $scope.modalSubmit =function (){

                var dateObj = saveInit();
                var note = dateObj.note;

                var subject="Your Guest checked in";
                var listguesttext="";
                var body=' <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+
                        '<style>'+
                        ' body { font-family: "Hiragino Sans GB","微软雅黑"; }  </style> </head> <body style="margin: 0; padding: 0;"><div>Dear Mr/Mrs/Miss, </div>'+
                        '<div></div>'+
                        ' List guest checked in at Security room:';
                note.Status = "F";
                var mail="";
                var listguest=[];
                var listguestabsent="";
                var outputdate = moment($scope.recod.start_date).add(1, 'days').format('YYYY-MM-DD');
                var kinds = $scope.recod.start_area + "|" + $scope.recod.start_kind;
                GateGuest.GuestBasic().getEmail({UserID: Auth.username}).$promise.then(function (res) {
                    for (var i = 0; i < res.length; i++) {
                        mail= res[i].Email;

                    }
                }, function (errormessage) {
                    Notifications.addError({'status': 'error', 'message': errormessage});
                });

                GateGuest.GetGateCheckers().getCheckers({
                    owner: Auth.username,
                    fLowKey: "FEPVGateGuest",
                    Kinds: kinds,
                    CheckDate: $scope.recod.start_date
                }).$promise.then(function (res) {
                            var leaderList = [];
                            for (var i = 0; i < res.length; i++) {
                                leaderList[i] = res[i].Person;
                                console.log('Leader List: '+ leaderList[i])
                            }
                            if (leaderList.length <= 0 && dateObj.confirm != "NO") {
                                Notifications.addError({'status': 'error', 'message': $translate.instant('leaderError')});
                                return
                            } else {
                                $scope.formVariables.push({name: "GuestChecherArray", value: leaderList});
                                $scope.formVariables.push({name: "start_endDate", value: outputdate});
                                $scope.formVariables.push({name: "IsChecker", value: dateObj.confirm});
                                $scope.formVariables.push({name: "start_confirm", value: dateObj.confirm});
                                $scope.formVariables.push({name: "start_area", value: $scope.recod.start_area});
                                $scope.formVariables.push({name: "JWUser", value: "Guard"});

                                if (SaveGuest(note, function (voucherid, errormsg) {
                                            if (errormsg) {
                                                Notifications.addError({'status': 'error', 'message': errormsg});
                                            } else {
                                                $scope.formVariables.push({name: "VoucherID", value: voucherid});
                                                // $scope.formVariables.push({name: "email_to", value: mail});
                                                console.log('MAIL: '+ mail)
                                                // $scope.formVariables.push({name: "email_subject", value: subject});
                                                var RespondentName=[];

                                                GateGuest.GuestBasic().getGuestInfo({UserID: Auth.username, VoucherID:voucherid}).$promise.then(function (res) {

                                                    for (var i = 0; i < res.length; i++) {
                                                        listguest[i] = res[i].Name;
                                                        if (RespondentName.indexOf(res[i].RespondentName)=== -1) {
                                                            RespondentName.push(res[i].RespondentName);

                                                        }

                                                        listguesttext +='</br>'+'- '+ listguest[i];
                                                    }

                                                    body +=listguesttext +'</br> Respondent Name: '+ RespondentName+
                                                    '</b></br><b>Please confirm voucher before your Guest leave factory.</b></br>Thanks'+
                                                    '<footer> <div>Best Regards</div></footer>'+
                                                    ' </body></html>';



                                                    // $scope.formVariables.push({name: "email_text", value: body});
                                                    $scope.submitBykey(voucherid, function (submitres) {
                                                        if (submitres.status == "info") {

                                                            if (submitres.message) {

                                                                var queryObject = {processInstanceId: submitres.message};
                                                                EngineApi.getTasks().query(queryObject).$promise.then(function (nextres) {

                                                                    $scope.nexttasks = nextres;
                                                                    SearchList(1, 50);
                                                                    document.getElementById("EmployeeName").readOnly = true;
                                                                    document.getElementById("EmployeeID").readOnly = false;
                                                                    $('#messageModal').modal('hide');
                                                                    $('#nextModalGateGuest').modal('hide');
                                                                    $('#myModal').modal('hide');

                                                                }, function (errormessage) {
                                                                    Notifications.addError({
                                                                        'status': 'error',
                                                                        'message': errormessage
                                                                    });
                                                                });

                                                            } else {
                                                                Notifications.addError({
                                                                    'status': 'error',
                                                                    'message': "NO PID"
                                                                });
                                                            }
                                                        } else {
                                                            Notifications.addError({
                                                                'status': 'error',
                                                                'message': submitres.message
                                                            });
                                                        }
                                                    });
                                                });
                                            }

                                        }));
                            }

                        }, function (errormessage) {
                            Notifications.addError({'status': 'error', 'message': errormessage});
                        })




        }
        function asyncLoop(iterations, func, callback) {
            var index = 0;
            var done = false;
            var loop = {
                next: function() {
                    if (done) {
                        return;
                    }
                    if (index < iterations) {
                        index++;
                        func(loop);

                    } else {
                        done = true;
                        callback();
                    }
                },

                iteration: function() {
                    return index - 1;
                },

                break: function() {
                    done = true;
                    callback();
                }
            };
            loop.next();
            return loop;
        }


        $scope.savesubmit = function () {
            var kinds = $scope.recod.start_area + "|" + $scope.recod.start_kind;
            if( $scope.recod.start_kind=='2'){
                $scope.modalSubmit();
                return;
            }
            if( $scope.recod.start_area=='1' ){
                GateGuest.GuestBasic().checkUserBelongDyeing({
                    EmployeeID: Auth.username
                }).$promise.then(function (res) {

                            if(res[0].DepartmentID.substr(0,3)=='513'||res[0].DepartmentID.substr(0,3)=='519'||res[0].DepartmentID.substr(0,3)=='511'||res[0].DepartmentID.substr(0,3)=='510') {
                                GateGuest.GetGateCheckers().getCheckers({
                                    owner: Auth.username,
                                    fLowKey: "FEPVGateGuest",
                                    Kinds: kinds,
                                    CheckDate: $scope.recod.start_date
                                }).$promise.then(function (res) {

                                            var leaderList = [];
                                            asyncLoop(res[0].Person.split(',').length, function (loop) {
                                                        EngineApi.getMemberInfo().get({userid: res[0].Person.split(',')[loop.iteration()]}, function (ress) {

                                                            console.log(ress.Name);
                                                            leaderList.push(res[0].Person.split(',')[loop.iteration()] + ' -- ' + ress.Name)

                                                            loop.next();
                                                        });
                                                    },
                                                    function () {

                                                    });
                                            $scope.listleadercheck=leaderList;
                                        }, function (errormessage) {
                                            Notifications.addError({'status': 'error', 'message': errormessage});
                                        })
                                console.log('List of leader checker: '+ $scope.listleadercheck);
                                $('#messageModal').modal('show');
                            }
                            else if(res[0].DepartmentID.substr(0,3)=='512'){
                                GateGuest.GetGateCheckers().getCheckers({
                                    owner: Auth.username,
                                    fLowKey: "FEPVGateGuest",
                                    Kinds: kinds,
                                    CheckDate: $scope.recod.start_date
                                }).$promise.then(function (res) {
                                            var leaderList = [];
                                            asyncLoop(res[0].Person.split(',').length, function (loop) {
                                                        EngineApi.getMemberInfo().get({userid: res[0].Person.split(',')[loop.iteration()]}, function (ress) {

                                                            console.log(ress.Name);
                                                            leaderList.push(res[0].Person.split(',')[loop.iteration()] + ' -- ' + ress.Name)

                                                            loop.next();
                                                        });
                                                    },
                                                    function () {

                                                    });
                                            $scope.listleadercheck=leaderList;
                                        }, function (errormessage) {
                                            Notifications.addError({'status': 'error', 'message': errormessage});
                                        })
                                $scope.showMessageModal='';
                                $('#messageModal').modal('show');


                            }
                        }, function (errResponse) {
                            Notifications.addError({'status': 'error', 'message': errResponse});
                        });


            }
            else{
                var dateObj = saveInit();
                var note = dateObj.note;

                var subject="Your Guest checked in";
                var listguesttext="";
                var body=' <html> <head> <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />'+
                        '<style>'+
                        ' body { font-family: "Hiragino Sans GB","微软雅黑"; }  </style> </head> <body style="margin: 0; padding: 0;"><div>Dear Mr/Mrs/Miss, </div>'+
                        '<div></div>'+
                        ' List guest checked in at Security room:';
                note.Status = "F";
                var mail="";
                var listguest=[];
                var listguestabsent="";
                var outputdate = moment($scope.recod.start_date).add(1, 'days').format('YYYY-MM-DD');
                var kinds = $scope.recod.start_area + "|" + $scope.recod.start_kind;
                GateGuest.GuestBasic().getEmail({UserID: Auth.username}).$promise.then(function (res) {
                    for (var i = 0; i < res.length; i++) {
                        mail= res[i].Email;

                    }
                }, function (errormessage) {
                    Notifications.addError({'status': 'error', 'message': errormessage});
                });

                GateGuest.GetGateCheckers().getCheckers({
                    owner: Auth.username,
                    fLowKey: "FEPVGateGuest",
                    Kinds: kinds,
                    CheckDate: $scope.recod.start_date
                }).$promise.then(function (res) {

                                var leaderList = [];
                                asyncLoop(res[0].Person.split(',').length, function (loop) {
                                            EngineApi.getMemberInfo().get({userid: res[0].Person.split(',')[loop.iteration()]}, function (ress) {

                                                console.log(ress.Name);
                                                leaderList.push(res[0].Person.split(',')[loop.iteration()] + ' -- ' + ress.Name)

                                                loop.next();
                                            });
                                        },
                                        function () {

                                        });
                            $scope.showMessageModal='';
                                $scope.listleadercheck=leaderList;
                            }, function (errormessage) {
                                Notifications.addError({'status': 'error', 'message': errormessage});
                            })
                            console.log('List of leader checker: '+ $scope.listleadercheck);
                            $('#messageModal').modal('show');


            }


        };

        function SaveGuest(note, callback) {
            GateGuest.SaveGuest().save(note).$promise.then(function (res) {
                var voucherid = res.VoucherID;
                if (voucherid) {
                    $scope.recod.start_voucherid = voucherid;
                    callback(voucherid, "")

                } else {
                    callback(voucherid, $translate.instant('saveError'))
                }
            }, function (errormessage) {
                callback("", errormessage)
            });
        }

        $scope.saveDraft = function () {
            var dateObj = saveInit();
            var note = dateObj.note;
            SaveGuest(note, function (voucherid, message) {
                if (voucherid) {
                    $scope.recod.start_voucherid = voucherid;
                    Notifications.addMessage({'status': 'information', 'message': $translate.instant('saveSuccess')});
                } else {
                    Notifications.addError({'status': 'error', 'message': $translate.instant('saveError') + message});
                }
            })

        };
        $scope.returnBack = function () {
            document.getElementById("Search").style.display = "";
            document.getElementById("detailView").style.display = "none";
            historyurl = "";
        };
        //修改
        $scope.getVoucher = function (obj) {

            GateGuest.GuestBasic().getGuest({
                VoucherID: obj.entity.VoucherID,
                Language: lang
            }).$promise.then(function (res) {
                        console.log(res);
                        if (res[0].Status == "N" || !res[0].Status) {
                            if (res[0].UserID == Auth.username) {
                                $scope.recod.start_kind = res[0].GuestType;
                                $scope.recod.start_code = res[0].Respondent;
                                $scope.recod.start_area = res[0].Region;
                                $scope.recod.start_phone = res[0].ExtNO;
                                $scope.recod.start_company = res[0].Enterprise;

                                $scope.recod.start_date = res[0].ExpectIn;
                                $scope.guestItems = res[0].GuestItems;
                                $scope.recod.start_reason = res[0].Content;
                                $scope.recod.start_voucherid = res[0].VoucherID;

                                $('#myModal').modal('show');
                            } else {
                                Notifications.addError({
                                    'status': 'error',
                                    'message': $translate.instant('creatorError')
                                });
                            }
                        } else {
                            console.log('TEST: '+ $scope.recod.start_date);
                            console.log('TESTSSSS: '+ res[0].ExpectOutTime);
                            $scope.details = res[0];
                            //  $scope.details
                            $scope.details.Status = $scope.getVoucherStatus($scope.details.Status);
                            $scope.details.GuestType = $scope.getVoucherGuestType($scope.details.GuestType);
                            $scope.details.Region = $scope.getVoucherRegion($scope.details.Region);
                            //$scope.details.ExpectIn=res[0].ExpectIn;
                            $scope.details.ExpectOutTime=res[0].ExpectOutTime;
                            $scope.detailsGuestItems = res[0].GuestItems;
                            $scope.details.VehicleNo = res[0].VehicleNo;
                            Notifications.addError({'status': 'error', 'message': $translate.instant('draftError')});
                            document.getElementById("detailView").style.display = "";
                            document.getElementById("Search").style.display = "none";
                            GateGuest.GetGateGuestPID().get({
                                VoucherID: obj.entity.VoucherID,
                                activityName: "StartEvent_Create"
                            }).$promise.then(function (res) {
                                        historyurl = "#/processlog/" + res.ProcessInstanceId;
                                        $scope.$emit('historyurl', historyurl);
                                    }, function (errormessage) {
                                        console.log(errormessage);
                                        //  Notifications.addError({'status': 'error', 'message': errormessage});
                                    });
                        }

                    }, function (errormessage) {
                        Notifications.addError({'status': 'error', 'message': errormessage});
                    });


        };

        $scope.change = function(){
            console.log('TEST: '+$scope.getVoucherRegion($scope.recod.start_area));
            if($scope.recod.start_area=='1'){
                Notifications.addWarning({'status': 'warning', 'message': $translate.instant('saveSuccess')});
            }else{

            }
        }

        //贵宾的生成
        $scope.produce = function () {
            if (!$scope.GuestNumber) {
                return;
            }
            else {
                if ($scope.GuestNumber > 100) {
                    Notifications.addError({'status': 'error', 'message': $translate.instant('msg_itemNum') + message});
                } else {
                    $scope.guestItems = [];
                    for (var i = 0; i < $scope.GuestNumber; i++) {
                        var j = i + 1;
                        $scope.items = {};
                        $scope.items.GuestName = "Guest" + j;
                        $scope.items.IdCard = "IdCard";
                        $scope.guestItems.push($scope.items);
                    }
                }
            }
        };
        $scope.searchEmployeeInfo = function () {
            if (document.getElementById("EmployeeName").readOnly != false) {
                document.getElementById("EmployeeName").readOnly = false;
                document.getElementById("EmployeeID").readOnly = true;
                $scope.recod.start_code = "";
            }
            else {
                document.getElementById("EmployeeID").readOnly = false;
                document.getElementById("EmployeeName").readOnly = true;
            }
        }
        $scope.checkErr = function() {
            var startDate = $scope.recod.start_date;
            var endDate = $scope.recod.ExpectOutTime;
            $scope.errMessage = '';
            if(new Date(startDate) > new Date(endDate)){
                $scope.errMessage = 'End Date should be greater than Start Date';
                Notifications.addError({'status': 'error', 'message':  $scope.errMessage});
                document.getElementById("btnSaveDraft").disabled = true;
                document.getElementById("btnSubmit").disabled = true;
                $scope.$apply();
                return;
            }else
            {
                document.getElementById("btnSaveDraft").disabled = false;
                document.getElementById("btnSubmit").disabled = false;
            }

        };
        $scope.setEndDate= function(){
            $scope.recod.ExpectOutTime = $filter('date')(new Date($scope.recod.start_date),'yyyy-MM-dd 17:00');
            $scope.$apply();

        };
        $scope.setdateTo = function()
        {
            $scope.dateTo = $filter('date')(new Date($scope.dateFrom),'yyyy-MM-dd');
            $scope.$apply();
        }
    }
</script>
<div ng-controller="GateGuest_start">
    <div id="detailView" style="display: none;">
        <div class="col-sm-12" style="padding-top: 20px;">
            <legend><h3>{{'GuestPlan'|translate}}</h3></legend>
            <div class="col-sm-7">
                <table class="table table-bordered"
                       style="table-layout:fixed;">
                    <tr>
                        <td>{{'VoucherID'|translate}}：{{details.VoucherID}}</td>
                        <td>{{'GuestType'|translate}}：{{details.GuestType}}</td>
                    </tr>
                    <tr>
                        <td>{{'Region'|translate}}：{{details.Region}}</td>
                        <td>{{'Enterprise'|translate}}：{{details.Enterprise}}</td>
                    </tr>
                    <tr>
                        <td>{{'Respondent'|translate}}：{{details.Respondent}}</td>
                        <td>{{'UserID'|translate}}：{{details.UserID}}</td>
                    </tr>
                    <tr>
                        <td>{{'ExtNO'|translate}}：{{details.ExtNO}}</td>
                        <td>{{'ExpectIn'|translate}}：{{details.ExpectIn}}</td>
                    </tr>
                    <tr>
                        <td>{{'VehicleNO'|translate}}：{{details.VehicleNo}}</td>
                        <td>{{'GoodsExpectOut'|translate}}：{{details.ExpectOutTime}}</td>
                    </tr>
                    <tr>
                        <td>{{'Content'|translate}}：{{details.Content}}</td>
                        <td>{{'Status'|translate}}：{{details.Status}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">{{'InTime'|translate}}：{{details.InTime.substring(0,19)}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">{{'Complete'|translate}}：{{details.Complete.substring(0,19)}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">{{'OutTime'|translate}}：{{details.OutTime.substring(0,19)}}</td>
                    </tr>
                    <tr>
                        <td colspan="2">{{'UpdateTime'|translate}}:{{details.Stamp.substring(0,19)}}</td>
                    </tr>
                </table>
                <button type="button" class="btn btn-primary" ng-click="returnBack()">{{'return'|translate}}

                </button>

            </div>
            <div class="col-sm-5">
                <table class="table table-bordered"
                       style="table-layout:fixed;padding-left: 20px;float: left;postion: relative;">
                    <tr>
                        <td>{{'GuestName'|translate}}</td>
                        <td>{{'GuestIDCard'|translate}}</td>
                    </tr>
                    <tr ng-repeat="guestItem in detailsGuestItems">
                        <td>{{guestItem.GuestName}}</td>
                        <td>{{guestItem.IdCard}}</td>
                    </tr>
                </table>
                <label class="col-sm-8 control-label">{{'ISOCode'|translate}}：ASAGSQR005-03</label></label>
            </div>

        </div>
    </div>

    <div id="Search">
        <form class="form-horizontal" role="form" novalidate name="form">
            <legend><h3>{{'GuestQuery'|translate}}</h3></legend>
            <div class="col-sm-12 form-group">
                <div class="form-group search-table">

                    <div class=" form-group ">
                        <label class="col-sm-3 control-label">{{'InTime'|translate}}</label>

                        <div class="col-sm-2">
                            <input class="form-control" type="text" name="dateFrom"
                                   ng-change="setdateTo()"
                                   ng-model="dateFrom" date-picker/>
                        </div>
                        <label class="col-sm-3 control-label">{{'dateTo'|translate}}</label>

                        <div class="col-sm-2">
                            <input class="form-control" type="text" name="dateTo" ng-model="dateTo" date-picker/>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{'Enterprise'|translate}}</label>

                        <div class="col-sm-2">
                            <input type="text" class="form-control" name="enterprise" ng-model="enterprise">
                        </div>

                        <label class="col-sm-3 control-label">{{'VoucherID'|translate}}</label>

                        <div class="col-sm-2">
                            <input type="text" class="form-control" name="VoucherID" ng-model="VoucherID">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{'Region'|translate}}</label>

                        <div class="col-sm-2">
                            <!--<select class="form-control" name="Region" ng-model="region"-->
                                    <!--ng-options="c.ID as c.Region for c in regions">-->
                                <!--<option value="">-- ALL --</option>-->
                            <select class="form-control" type="text" name="start_area" ng-model="recod.start_area"
                                    max="0"
                                    history-field="Region" required ng-change="confirm();"
                                    ng-options="t.ID as t.Region for t in regions"></select>
                        </div>
                        <label class="col-sm-3 control-label">{{'GuestType'|translate}}</label>

                        <div class="col-sm-2">
                            <select class="form-control" name="GuestType" ng-model="guestType"
                                    ng-options="c.ID as c.GuestType for c in kind">
                                <option value="">-- ALL --</option>
                            </select>
                        </div>

                    </div>
                    <div class="form-group">
                        <label class="col-sm-3 control-label">{{'Status'|translate}}</label>

                        <div class="col-sm-2">
                            <select class="form-control" name="status" ng-model="status"
                                    ng-options="c.Status as c.Remark for c in StatusList">
                                <option value="">-- ALL --</option>
                                Flowchart               </select>
                        </div>
                        <div class="col-sm-3">
                            <label></label>
                        </div>
                        <div class="col-sm-2">
                            <label>
                                <input name="onlyOwner" type="checkbox" ng-model="onlyOwner"> {{'onlyOwner'|translate}}
                            </label></div>
                        <div class="col-sm-1">
                            <button type="button" class="btn btn-primary" ng-click="Search()">{{'Search'|translate}}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div style="width: 100%;">
                <div id="Grid" ui-grid="gridOptions" class="grid" ui-grid-selection ui-grid-pagination
                     ui-grid-resize-columns
                     ui-grid-core ui-grid-exporter></div>
            </div>
        </form>
    </div>


    <div class="modal fade" id="myModal" role="dialog" aria-labelledby="myLargeModalLabel" data-backdrop="static"
         data-keyboard="false">

        <div class="modal-dialog modal-lg">
            <div class="modal-content">

                <div class="modal-body" style="padding-bottom:3px">
                    <form class="form-horizontal" role="form" name="formGuest" novalidate>
                        <H4 style="background-color: #ececec; padding:3px">{{'GuestPlan'|translate}}</H4>

                        <div class="form-group">
                            <label class="col-sm-2 control-label">{{'VoucherID'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="start_voucherid" readonly
                                       ng-model="recod.start_voucherid"
                                        />
                            </div>
                            <label class="col-sm-2 control-label">*{{'GuestType'|translate}}</label>

                            <div class="col-sm-4">
                                <select class="form-control" type="text" name="start_kind" ng-model="recod.start_kind"
                                        max="0"
                                        required history-field="GuestType" form-field
                                        ng-options="t.ID as t.GuestType for t in kind">
                                </select>
                            </div>

                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">*{{'Respondent'|translate}}</label>

                            <div class="col-sm-4">
                                <input id="EmployeeID" class="form-control" type="text" name="start_code"
                                       ng-model="recod.start_code"
                                       history-field="Respondent" required/>
                            </div>

                            <label class="col-sm-2 control-label">*{{'ExpectIn'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="start_date" ng-model="recod.start_date"
                                       id="startDate"
                                       date-picker time="Y-m-d H:i"
                                       ng-change="setEndDate()"
                                       history-field="ExpectIn" min="0" form-field required/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">*{{'Name'|translate}}</label>

                            <div class="col-sm-4">
                                <div class="input-group">
                                    <input id="EmployeeName" class="form-control" type="text" name="start_name"
                                           ng-model="recod.start_name"
                                           history-field="Name" required readonly auto-complete
                                           autocomplete="off"/>
                                    <!-- <select id="EmployeeName" style="width: 100%" ui-select2 ng-model="recod.start_name" name="start_name" required readonly auto-complete >
                                           <option ng-repeat="value in employeeInfo" value="{{value.Name}}">
                                               {{value.Name}}
                                           </option>
                                       </select>-->
                                       <span class="input-group-btn">
                                           <button class="btn btn-primary btn-sm" ng-click="searchEmployeeInfo()"><span
                                                   class="glyphicon glyphicon-search"></span></button>
                                       </span>
                                </div>
                            </div>

                            <label class="col-sm-2 control-label">*{{'Enterprise'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="start_company"
                                       ng-model="recod.start_company"
                                       history-field="Enterprise" required/>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">{{'DepartmentSpc'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="DepartmentSpc" readonly
                                       ng-model="recod.DepartmentSpc"
                                       max="0"
                                       history-field="DepartmentSpc" required/>
                            </div>


                            <label class="col-sm-2 control-label">*{{'Region'|translate}}</label>

                            <div class="col-sm-4">
                                <select class="form-control" type="text" name="start_area" ng-model="recod.start_area"
                                        max="0"
                                        history-field="Region" required ng-change="confirm();"
                                        ng-options="t.ID as t.Region for t in regions"></select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">*{{'ExtNO'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="start_phone" ng-model="recod.start_phone"
                                       max="0"
                                       history-field="ExtNO" required/>
                            </div>
                            <label class="col-sm-2 control-label">{{'GoodsExpectOut'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="ExpectOutTime"
                                       id="endDate"
                                       ng-change="checkErr()"
                                       ng-model="recod.ExpectOutTime"
                                       date-picker time="Y-m-d H:i"
                                       history-field="GoodsExpectOut" form-field>

                            </div>


                            <!-- <div id="number" ng-show="recod.start_kind=='3'">
                                 <label class="col-sm-2 control-label">*{{'GuestNumber'|translate}}</label>

                                 <div class="col-sm-2">
                                     <input class="form-control" type="number" name="GuestNumber"
                                            ng-model="GuestNumber"
                                            history-field="GuestNumber" form-field/>
                                 </div>
                                 <button type="button" class="btn btn-primary" ng-click="produce()">
                                     {{'produce'|translate}}
                                 </button>
                             </div>-->
                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">{{'VehicleNO'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="VehicleNo" ng-model="recod.VehicleNo"
                                       history-field="VehicleNO" form-field>
                            </div>


                        </div>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">*{{'Content'|translate}}</label>

                            <div class="col-sm-10">
                                <textarea class="form-control" type="text" name="start_reason"
                                          ng-model="recod.start_reason" max="0"
                                          history-field="Content" form-field required/>
                            </div>
                        </div>
                    </form>
                    <H4 style="background-color: #ececec; padding:3px">{{'GuestDetails'|translate}}</H4>

                    <form class="form-horizontal" role="form" name="formdetail" novalidate>
                        <div class="form-group">
                            <label class="col-sm-2 control-label">*{{'GuestName'|translate}}</label>

                            <div class="col-sm-3">
                                <input class="form-control" type="text" name="newName" ng-model="note.GuestName"
                                       required/>
                            </div>

                            <label ng-show="recod.start_kind=='3'" class="col-sm-2 control-label">{{'GuestIDCard'|translate}}</label>
                            <label ng-hide="recod.start_kind =='3'" class="col-sm-2 control-label">*{{'GuestIDCard'|translate}}</label>

                            <div class="col-sm-4">
                                <input class="form-control" type="text" name="newidCard" ng-model="note.IdCard"
                                       max="0"/>
                            </div>

                            <div class="col-sm-1">
                                <button type="button" class="btn btn-primary" ng-click="addGuestItem()"
                                        ng-disabled="formdetail.$invalid">{{'Add'}}
                                </button>
                            </div>
                        </div>
                    </form>
                    <table id="temptable" ng-table="tableParams" class="table table-bordered">
                        <tr ng-repeat="guestItem in guestItems">
                            <td title="'GuestName'" width="350px">
                                {{guestItem.GuestName}}
                            </td>
                            <td title="'GuestName'" width="350px">
                                {{guestItem.IdCard}}
                            </td>
                            <td>
                                <a ng-click="deleteGuestItem($index)"
                                   class="btn-xs btn btn-danger">{{'Delete'|translate}}</a>
                            </td>
                        </tr>
                    </table>
                </div>
                <div class="modal-footer">
                    <label style="color: #FF0000;float: left" >{{'GuestConfirm'|translate}}</label>
                    <button type="button" class="btn btn-default" ng-click="reset()">{{'Close'|translate}}</button>
                    <button type="button" id="btnSaveDraft" class="btn btn-warning"
                            ng-click="saveDraft()" ng-disabled="formGuest.$invalid ||guestItems.length<1">
                        {{'saveDraft'|translate}}
                    </button>
                    <button type="button" id="btnSubmit" class="btn btn-primary"
                            ng-click="savesubmit()" ng-disabled="formGuest.$invalid ||guestItems.length<1">
                        {{'saveSubmit'|translate}}
                    </button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->
    <div ng-include="'forms/GateGuest/NextTask.html'"></div>
    <!-- /.modal -->
</div>